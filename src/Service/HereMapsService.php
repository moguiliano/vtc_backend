<?php

namespace App\Service;

use Symfony\Contracts\HttpClient\HttpClientInterface;

class HereMapsService
{
    private $client;
    private $apiKey;

    public function __construct(HttpClientInterface $client)
    {
        $this->client = $client;
        $this->apiKey = '5vQSLKBwontpC6yqQeoA9Hp5_ytsyeN1SldFAQW1Ks8'; // Remplace par ta cl√© API
    }
        
    // üó∫Ô∏è Convertit une adresse en coordonn√©es GPS

    public function geocodeAddress($address)
    {
        $encodedAddress = urlencode($address);
        $url = "https://geocode.search.hereapi.com/v1/geocode?q={$encodedAddress}&apiKey={$this->apiKey}";

        $response = $this->client->request('GET', $url);
        $data = $response->toArray();

        if (isset($data['items'][0]['position'])) {
            return [
                'lat' => $data['items'][0]['position']['lat'],
                'lng' => $data['items'][0]['position']['lng']
            ];
        }

        return null;
    }
        // üöó R√©cup√®re la distance et la dur√©e en utilisant les coordonn√©es GPS

        public function getDistanceAndDuration($originAddress, $destinationAddress)
        {
            // üó∫Ô∏è Convertir les adresses en coordonn√©es GPS
            $origin = $this->geocodeAddress($originAddress);
            $destination = $this->geocodeAddress($destinationAddress);
        
            if (!$origin || !$destination) {
                return ['error' => 'Impossible de g√©ocoder une ou plusieurs adresses'];
            }
        
            // Construire l'URL avec les coordonn√©es GPS
            $url = "https://router.hereapi.com/v8/routes?transportMode=car&origin={$origin['lat']},{$origin['lng']}&destination={$destination['lat']},{$destination['lng']}&return=summary&apiKey={$this->apiKey}";
        
            // üõ† Debug : Log l'URL pour voir si elle est bien format√©e
            error_log("HERE Routing Request: " . $url);
        
            $response = $this->client->request('GET', $url);
        
            // V√©rifier le statut HTTP de la r√©ponse
            if ($response->getStatusCode() !== 200) {
                error_log("Erreur HERE API: " . $response->getContent(false)); // Log l'erreur
                return ['error' => 'Erreur lors de la requ√™te vers HERE API'];
            }
        
            // Essayer de parser la r√©ponse
            try {
                $data = $response->toArray();
            } catch (\Exception $e) {
                error_log("Erreur de conversion JSON: " . $e->getMessage());
                return ['error' => 'R√©ponse invalide de HERE API'];
            }
        
            if (isset($data['routes'][0]['sections'][0]['summary'])) {
                $summary = $data['routes'][0]['sections'][0]['summary'];
                return [
                    'distance_km' => round($summary['length'] / 1000, 2),
                    'duration_min' => round($summary['duration'] / 60, 2)
                ];
            }
        
            return ['error' => 'Aucun itin√©raire trouv√©'];
        }
        
}
