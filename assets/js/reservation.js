  const ReservationApp = {
    apiKey: "",

    /**
     * Charge la cl√© API depuis l'endpoint Symfony '/get-api-key'
     */
    loadApiKey: async function () {
      try {
        const response = await fetch('/get-api-key');
        const data = await response.json();
        this.apiKey = data.apiKey;
        console.log("Cl√© API charg√©e.");
      } catch (error) {
        console.error("Erreur lors de la r√©cup√©ration de la cl√© API :", error);
      }
    },

    /**
     * R√©cup√®re et affiche les suggestions d'adresse pour un champ donn√©.
     * @param {string} inputId - L'ID du champ de saisie.
     */
    fetchSuggestions: async function (inputId) {
      const inputField = document.getElementById(inputId);
      const suggestionsList = document.getElementById(`${inputId}-suggestions`);
      const query = inputField.value.trim();

      // Si la saisie est trop courte, on vide la liste des suggestions
      if (query.length < 3) {
        if (suggestionsList) {
          suggestionsList.innerHTML = "";
        }
        return;
      }

      // Construction de l'URL de l'API HERE pour l'autocompl√©tion
      const url = `https://geocode.search.hereapi.com/v1/geocode?q=${encodeURIComponent(query)}&apikey=${this.apiKey}`;

      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Erreur HTTP : ${response.status}`);
        }
        const data = await response.json();
        this.displaySuggestions(data.items, inputId);
      } catch (error) {
        console.error("Erreur lors de la requ√™te :", error);
      }
    },

    /**
     * Affiche la liste des suggestions sous le champ de saisie.
     * @param {Array} suggestions - Liste d'objets suggestion.
     * @param {string} inputId - L'ID du champ de saisie.
     */
    displaySuggestions: function (suggestions, inputId) {
      const inputField = document.getElementById(inputId);
      let suggestionsList = document.getElementById(`${inputId}-suggestions`);
      
      // Si la liste n'existe pas, on la cr√©e
      if (!suggestionsList) {
        suggestionsList = document.createElement("ul");
        suggestionsList.id = `${inputId}-suggestions`;
        suggestionsList.classList.add("suggestions-list");
        inputField.parentNode.appendChild(suggestionsList);
      }

      // R√©initialiser la liste des suggestions
      suggestionsList.innerHTML = "";

      if (!suggestions || suggestions.length === 0) {
        suggestionsList.innerHTML = "<li>Aucune suggestion trouv√©e</li>";
        return;
      }

      suggestions.forEach(item => {
        const li = document.createElement("li");
        li.textContent = item.title;
        li.addEventListener("click", () => {
          inputField.value = item.title;
          suggestionsList.innerHTML = "";
        });
        suggestionsList.appendChild(li);
      });
    },

    /**
     * Configure l'autocompl√©tion sur un champ donn√©.
     * @param {string} inputId - L'ID du champ de saisie.
     */
    setupAutocomplete: function (inputId) {
      const inputField = document.getElementById(inputId);
      if (inputField) {
        inputField.setAttribute("autocomplete", "off");
        inputField.addEventListener("keyup", () => this.fetchSuggestions(inputId));
      }
    },

    /**
     * Cr√©e et ajoute un bouton de g√©olocalisation pour un champ donn√©.
     * @param {string} inputId - L'ID du champ de saisie.
     */
    setupGeolocation: function (inputId) {
      const inputField = document.getElementById(inputId);
      if (inputField) {
        // √âviter d'ajouter plusieurs boutons pour le m√™me champ
        if (!inputField.parentNode.querySelector(`button[data-target="${inputId}"]`)) {
          const geoButton = document.createElement("button");
          geoButton.type = "button";
          geoButton.textContent = "üìç Utiliser ma position";
          geoButton.classList.add("geoButton");
          geoButton.setAttribute("data-target", inputId);
          geoButton.addEventListener("click", () => this.useGeolocation(inputId));
          inputField.parentNode.appendChild(geoButton);
        }
      }
    },

    /**
     * Utilise la g√©olocalisation pour remplir un champ avec l'adresse actuelle.
     * @param {string} inputId - L'ID du champ de saisie.
     */
    useGeolocation: async function (inputId) {
      if (!navigator.geolocation) {
        alert("La g√©olocalisation n'est pas support√©e par votre navigateur.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const url = `https://revgeocode.search.hereapi.com/v1/revgeocode?at=${lat},${lng}&apikey=${this.apiKey}`;

          try {
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error(`Erreur HTTP : ${response.status}`);
            }
            const data = await response.json();
            if (data.items && data.items.length > 0) {
              document.getElementById(inputId).value = data.items[0].address.label;
            } else {
              alert("Impossible de trouver votre adresse.");
            }
          } catch (error) {
            console.error("Erreur lors de la r√©cup√©ration de l'adresse :", error);
          }
        },
        (error) => {
          alert("Impossible d'obtenir votre position. V√©rifiez vos autorisations.");
          console.error("Erreur de g√©olocalisation :", error);
        }
      );
    },

    /**
     * Initialise l'application : charge la cl√© API et configure les fonctionnalit√©s.
     */
    init: async function () {
      // Charger la cl√© API
      await this.loadApiKey();

      // Liste des IDs des champs √† configurer
      const inputIds = [
        'reservation_depart',
        'reservation_arrivee',
        'reservation_lieuArret'
      ];
      inputIds.forEach(id => {
        this.setupAutocomplete(id);
        this.setupGeolocation(id);
      });

      // Gestion de l'affichage du champ d'arr√™t en fonction de la checkbox
      const stopCheckbox = document.getElementById("reservation_Stop");
      const stopoverLocation = document.getElementById("stopover-location");
      if (stopCheckbox && stopoverLocation) {
        stopCheckbox.addEventListener("change", function () {
          stopoverLocation.style.display = this.checked ? "block" : "none";
        });
      }
    }
  };

  // Masquer les listes de suggestions lorsqu'on clique en dehors du champ
  document.addEventListener("click", (event) => {
    document.querySelectorAll(".suggestions-list").forEach(list => {
      if (!list.previousElementSibling.contains(event.target) &&
          !list.contains(event.target)) {
        list.innerHTML = "";
      }
    });
  });

  // Initialiser l'application lorsque le DOM est enti√®rement charg√©
  document.addEventListener("DOMContentLoaded", () => {
    ReservationApp.init();
  });

  // --------------------------------------------------
  // Gestion du formulaire de r√©servation
  // --------------------------------------------------
  document.getElementById('reservation-form').addEventListener('submit', function (event) {
    event.preventDefault(); // Emp√™che la soumission classique du formulaire

    // R√©cup√©rer les valeurs des champs "d√©part" et "arriv√©e"
    const origin = document.getElementById('reservation_depart').value;
    const destination = document.getElementById('reservation_arrivee').value;

    if (!origin || !destination) {
      alert("Veuillez saisir une adresse de d√©part et d'arriv√©e !");
      return;
    }

    // Envoie une requ√™te POST pour r√©cup√©rer la distance et la dur√©e estim√©e
    fetch('/distance', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ origin, destination })
    })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
        } else {
          // Affiche les r√©sultats dans les √©l√©ments d√©di√©s
          document.getElementById('distance').innerText = `Distance : ${data.distance_km} km`;
          document.getElementById('duration').innerText = `Dur√©e estim√©e : ${data.duration_min} min`;
        }
      })
      .catch(error => console.error('Erreur:', error));
  });
